{"version":3,"file":"sc-downloads-list.js","sourceRoot":"","sources":["../../../../../src/components/controllers/dashboard/sc-downloads-list/sc-downloads-list.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Component, h, Prop, State, Element } from '@stencil/core';\nimport apiFetch from '../../../../functions/fetch';\nimport { __ } from '@wordpress/i18n';\nimport { addQueryArgs } from '@wordpress/url';\n\nimport { Download, Media } from '../../../../types';\nimport { onFirstVisible } from '../../../../functions/lazy';\n\n@Component({\n  tag: 'sc-downloads-list',\n  styleUrl: 'sc-downloads-list.scss',\n  shadow: true,\n})\nexport class ScDownloadsList {\n  @Element() el: HTMLScDownloadsListElement;\n  @Prop() customerId: string;\n  @Prop() productId: string;\n  @Prop() heading: string;\n  @State() downloads: Download[];\n  @State() downloading: string;\n  @State() busy: boolean;\n  @State() error: string;\n  @State() pagination: {\n    total: number;\n    total_pages: number;\n  } = {\n    total: 0,\n    total_pages: 0,\n  };\n  @Prop({ mutable: true }) query: any = {\n    page: 1,\n    per_page: 20,\n  };\n\n  componentWillLoad() {\n    onFirstVisible(this.el, () => {\n      this.fetchItems();\n    });\n  }\n\n  async fetchItems() {\n    if (!this.productId || !this.customerId) {\n      return;\n    }\n    try {\n      this.busy = true;\n      await this.getItems();\n    } catch (e) {\n      console.error(this.error);\n      this.error = e?.message || __('Something went wrong', 'surecart');\n    } finally {\n      this.busy = false;\n    }\n  }\n\n  /** Get all subscriptions */\n  async getItems() {\n    const response = (await apiFetch({\n      path: addQueryArgs(`surecart/v1/downloads/`, {\n        product_ids: [this.productId],\n        customer_ids: [this.customerId],\n        downloadable: true,\n        ...this.query,\n      }),\n      parse: false,\n    })) as Response;\n    this.pagination = {\n      total: parseInt(response.headers.get('X-WP-Total')),\n      total_pages: parseInt(response.headers.get('X-WP-TotalPages')),\n    };\n    this.downloads = (await response.json()) as Download[];\n    return this.downloads;\n  }\n\n  nextPage() {\n    this.query.page = this.query.page + 1;\n    this.fetchItems();\n  }\n\n  prevPage() {\n    this.query.page = this.query.page - 1;\n    this.fetchItems();\n  }\n\n  async downloadItem(download) {\n    if (download?.url) {\n      this.downloadFile(download.url, download?.name ?? 'file');\n      return;\n    }\n\n    const mediaId = download?.media?.id;\n    if (!mediaId) return;\n\n    try {\n      this.downloading = mediaId;\n      const media = (await apiFetch({\n        path: addQueryArgs(`surecart/v1/customers/${this.customerId}/expose/${mediaId}`, {\n          expose_for: 60,\n        }),\n      })) as Media;\n      if (!media?.url) {\n        throw {\n          message: __('Could not download the file.', 'surecart'),\n        };\n      }\n      this.downloadFile(media?.url, media.filename);\n    } catch (e) {\n      console.error(e);\n      this.error = e?.message || __('Something went wrong', 'surecart');\n    } finally {\n      this.downloading = null;\n    }\n  }\n\n  downloadFile(path, filename) {\n    // Create a new link\n    const anchor = document.createElement('a');\n    anchor.href = path;\n    anchor.download = filename;\n\n    // Append to the DOM\n    document.body.appendChild(anchor);\n\n    // Trigger `click` event\n    anchor.click();\n\n    // To make this work on Firefox we need to wait\n    // a little while before removing it.\n    setTimeout(() => {\n      document.body.removeChild(anchor);\n    }, 0);\n  }\n\n  renderFileExt = download => {\n    if (download?.media?.filename) {\n      return download.media.filename.split?.('.')?.pop?.();\n    }\n    if (download?.url) {\n      try {\n        const url = new URL(download.url);\n        if (url.pathname.includes('.')) {\n          return url.pathname.split?.('.')?.pop?.();\n        }\n      } catch (err) {\n        console.error(err);\n      }\n    }\n    return <sc-icon name=\"file\" />;\n  };\n\n  renderList() {\n    if (this?.busy && !this?.downloads?.length) {\n      return this.renderLoading();\n    }\n    if (!this?.downloads?.length) {\n      return this.renderEmpty();\n    }\n    const downloads = this.downloads || [];\n    \n    return (\n        <sc-card no-padding>\n        <sc-stacked-list>\n          {downloads.map(download => {\n            const media = download?.media as Media;\n            return (\n              <sc-stacked-list-row style={{ '--columns': '1' }}>\n                <sc-flex class=\"single-download\" justifyContent=\"flex-start\" alignItems=\"center\">\n                  <div class=\"single-download__preview\">{this.renderFileExt(download)}</div>\n                  <div>\n                    <div>\n                      <strong>{media?.filename ?? download?.name ?? ''}</strong>\n                    </div>\n\n                    <sc-flex justifyContent=\"flex-start\" alignItems=\"center\" style={{ gap: '0.5em' }}>\n                      {media?.byte_size && <sc-format-bytes value={media.byte_size}></sc-format-bytes>}\n\n                      {!!media?.release_json?.version && (\n                        <sc-tag\n                          type=\"primary\"\n                          size=\"small\"\n                          style={{\n                            '--sc-tag-primary-background-color': '#f3e8ff',\n                            '--sc-tag-primary-color': '#6b21a8',\n                          }}\n                        >\n                          v{media?.release_json?.version}\n                        </sc-tag>\n                      )}\n                    </sc-flex>\n                  </div>\n                </sc-flex>\n                <sc-button\n                  size=\"small\"\n                  slot=\"suffix\"\n                  onClick={() => this.downloadItem(download)}\n                  busy={media?.id ? this.downloading == media?.id : false}\n                  disabled={media?.id ? this.downloading == media?.id : false}\n                >\n                  {__('Download', 'surecart')}\n                </sc-button>\n              </sc-stacked-list-row>\n            );\n          })}\n        </sc-stacked-list>\n      </sc-card>\n    );\n  }\n\n  renderLoading() {\n    return (\n      <sc-card no-padding style={{ '--overflow': 'hidden' }}>\n        <sc-stacked-list>\n          <sc-stacked-list-row style={{ '--columns': '2' }} mobile-size={0}>\n            <div style={{ padding: '0.5em' }}>\n              <sc-skeleton style={{ width: '30%', marginBottom: '0.75em' }}></sc-skeleton>\n              <sc-skeleton style={{ width: '20%' }}></sc-skeleton>\n            </div>\n          </sc-stacked-list-row>\n        </sc-stacked-list>\n      </sc-card>\n    );\n  }\n\n  renderEmpty() {\n    return (\n      <div>\n        <sc-divider style={{ '--spacing': '0' }}></sc-divider>\n        <slot name=\"empty\">\n          <sc-empty icon=\"download\">{__(\"You don't have any downloads.\", 'surecart')}</sc-empty>\n        </slot>\n      </div>\n    );\n  }\n\n  render() {\n    return (\n      <sc-dashboard-module class=\"purchase\" part=\"base\" heading={__('Downloads', 'surecart')}>\n        <span slot=\"heading\">\n          <slot name=\"heading\">{this.heading || __('Downloads', 'surecart')}</slot>\n        </span>\n        {this.renderList()}\n        <sc-pagination\n          page={this.query.page}\n          perPage={this.query.per_page}\n          total={this.pagination.total}\n          totalPages={this.pagination.total_pages}\n          totalShowing={this?.downloads?.length}\n          onScNextPage={() => this.nextPage()}\n          onScPrevPage={() => this.prevPage()}\n        ></sc-pagination>\n         {this.busy && <sc-block-ui></sc-block-ui>}\n      </sc-dashboard-module>\n    );\n  }\n}\n"]}