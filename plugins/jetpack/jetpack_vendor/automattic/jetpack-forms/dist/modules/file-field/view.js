import*as e from"@wordpress/interactivity";var t={889:(e,t,n)=>{n.d(t,{S_:()=>r});const{__:__}=wp.i18n,r=(__("Warning.","jetpack-forms"),(e,t)=>{e.removeAttribute("aria-invalid"),e.removeAttribute("aria-describedby");const n=e.closest(t.hasInsetLabel?".contact-form__inset-label-wrap":".grunion-field-wrap");if(!n)return;const r=n.querySelector(".contact-form__input-error");r&&r.replaceChildren()})},833:(t,n,r)=>{t.exports=(e=>{var t={};return r.d(t,e),t})({getConfig:()=>e.getConfig,getContext:()=>e.getContext,getElement:()=>e.getElement,store:()=>e.store,withScope:()=>e.withScope})}},n={};function r(e){var i=n[e];if(void 0!==i)return i.exports;var o=n[e]={exports:{}};return t[e](o,o.exports,r),o.exports}r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var i=r(833),o=r(889);const a="jetpack/field-file";let s=null,l=null;const d=async()=>{if(s&&l&&Date.now()<l)return s;const{token:e,expiresAt:t}=await c();return s=e,l=1e3*t,s},c=async()=>{const{endpoint:e}=(0,i.getConfig)(a),t={token:null,expiresAt:0};try{const n=await fetch(`${e}/token`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({context:"file-upload"})});if(!n.ok)return t;const r=await n.json();return{token:r.token,expiresAt:r.expiration}}catch(e){if(e)return t}return t},f=(e,t=2)=>{const n=(0,i.getConfig)(a);if(0===e)return n.i18n.zeroBytes;const r=t<0?0:t,o=n.i18n.fileSizeUnits||["Bytes","KB","MB","GB","TB"],s=Math.floor(Math.log(e)/Math.log(1024)),l=parseFloat((e/Math.pow(1024,s)).toFixed(r));return`${new Intl.NumberFormat(n.i18n.locale,{minimumFractionDigits:r,maximumFractionDigits:r}).format(l)} ${o[s]}`},p=e=>{const t=new FileReader;t.readAsDataURL(e);const{ref:n}=(0,i.getElement)();(0,o.S_)(n,{hasInsetLabel:x(n)});const r=(0,i.getConfig)(a),s=(0,i.getContext)();let l=null;e.size>r.maxUploadSize&&(l=r.i18n.fileTooLarge),s.allowedMimeTypes.includes(e.type)||(l=r.i18n.invalidType);const d=s.files.filter((e=>!e.error));s.maxFiles<d.length+1&&(l=r.i18n.maxFiles);const c=performance.now()+"-"+Math.random();s.hasFiles=!0,s.files.push({name:e.name,formattedSize:f(e.size,2),isUploaded:!1,hasError:!!l,id:c,error:l});const p=(0,i.withScope)(u.bind(void 0,e,c));!l&&p(),t.onload=(0,i.withScope)((()=>{y({url:"url("+t.result+")"},c)}))},g=new Map;function*u(e,t){const{endpoint:n,i18n:r}=(0,i.getConfig)(a),o=yield d();if(!o)return void y({error:r.uploadFailed,hasError:!0},t);const s=new XMLHttpRequest,l=new FormData,c=new AbortController;g.set(t,c),s.open("POST",n,!0),s.upload.addEventListener("progress",(0,i.withScope)(m.bind(this,t))),s.addEventListener("readystatechange",(0,i.withScope)(h.bind(this,t))),c.signal.addEventListener("abort",(()=>{s.abort(),y({error:r.uploadFailed,hasError:!0},t)})),l.append("file",e),l.append("token",o),s.send(l)}const m=(e,t)=>{const n=t.loaded/t.total*100;y({progress:Math.min(n,97)},e)},h=(e,t)=>{const n=t.target;if(4===n.readyState){if(200!==n.status){const t=(0,i.getConfig)(a);return void y({error:t.i18n.uploadFailed,hasError:!0},e)}{const t=JSON.parse(n.responseText);if(t.success)return void y({file_id:t.data.file_id,isUploaded:!0,name:t.data.name,type:t.data.type,size:t.data.size,fileJson:JSON.stringify({file_id:t.data.file_id,name:t.data.name,size:t.data.size,type:t.data.type})},e)}if(n.responseText){const t=JSON.parse(n.responseText);y({error:t.message,hasError:!0},e)}}},y=(e,t)=>{const n=(0,i.getContext)(),r=n.files.findIndex((e=>e.id===t));n.files[r]=Object.assign(n.files[r],e)},x=e=>{const t=e.closest(".wp-block-jetpack-contact-form");return t&&t.classList.contains("is-style-outlined")||t.classList.contains("is-style-animated")};(0,i.store)(a,{state:{get hasFiles(){return!!(0,i.getContext)().files.length>0},get hasMaxFiles(){const e=(0,i.getContext)();return e.maxFiles<=e.files.length}},actions:{openFilePicker(){const{ref:e}=(0,i.getElement)(),t=e.parentNode.querySelector(".jetpack-form-file-field");t&&(t.value="",t.click())},fileAdded(e){Array.from(e.target.files).forEach(p)},fileDropped:e=>{if(e.preventDefault(),e.dataTransfer)for(const t of Array.from(e.dataTransfer.items)){if(t.webkitGetAsEntry()?.isDirectory)return;p(t.getAsFile())}(0,i.getContext)().isDropping=!1},dragOver:e=>{(0,i.getContext)().isDropping=!0,e.preventDefault()},dragLeave:()=>{(0,i.getContext)().isDropping=!1},removeFile:function*(e){e.preventDefault();const{ref:t}=(0,i.getElement)(),n=t.parentElement.parentElement.parentElement;(0,o.S_)(n,{hasInsetLabel:x(t)});const r=(0,i.getContext)(),s=e.target.dataset.id;if(g.has(s)){g.get(s).abort(),g.delete(s)}const l=r.files.find((e=>e.id===s));if(l&&l.file_id){const{endpoint:e}=(0,i.getConfig)(a),t=yield d();if(t){const n=new FormData;n.append("token",t),n.append("file_id",l.file_id),fetch(`${e}/remove`,{method:"POST",body:n})}}r.files=r.files.filter((e=>e.id!==s)),r.hasFiles=r.files.length>0}},callbacks:{}});