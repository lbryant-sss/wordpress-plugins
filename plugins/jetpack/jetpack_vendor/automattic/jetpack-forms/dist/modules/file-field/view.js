import*as e from"@wordpress/interactivity";var t={889:(e,t,o)=>{o.d(t,{S_:()=>n});const{__:__}=wp.i18n,n=(__("Warning.","jetpack-forms"),(e,t)=>{e.removeAttribute("aria-invalid"),e.removeAttribute("aria-describedby");const o=e.closest(t.hasInsetLabel?".contact-form__inset-label-wrap":".grunion-field-wrap");if(!o)return;const n=o.querySelector(".contact-form__input-error");n&&n.remove();const i=e.closest("form"),r=i.querySelectorAll(".contact-form__input-error"),s=i.querySelector(".contact-form__error");s&&0===r.length&&s.remove()})},833:(t,o,n)=>{t.exports=(e=>{var t={};return n.d(t,e),t})({getConfig:()=>e.getConfig,getContext:()=>e.getContext,getElement:()=>e.getElement,store:()=>e.store,withScope:()=>e.withScope})}},o={};function n(e){var i=o[e];if(void 0!==i)return i.exports;var r=o[e]={exports:{}};return t[e](r,r.exports,n),r.exports}n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var i=n(833),r=n(889);const s="jetpack/field-file";let a=null,l=null;const c=async()=>{if(a&&l&&Date.now()<l)return a;const{token:e,expiresAt:t}=await p();return a=e,l=1e3*t,a},p=async()=>{const{endpoint:e}=(0,i.getConfig)(s),t={token:null,expiresAt:0};try{const o=await fetch(`${e}/token`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({context:"file-upload"})});if(!o.ok)return t;const n=await o.json();return{token:n.token,expiresAt:n.expiration}}catch(e){if(e)return t}return t},f=(e,t=2)=>{const o=(0,i.getConfig)(s);if(0===e)return o.i18n.zeroBytes;const n=t<0?0:t,r=o.i18n.fileSizeUnits||["Bytes","KB","MB","GB","TB"],a=Math.floor(Math.log(e)/Math.log(1024)),l=parseFloat((e/Math.pow(1024,a)).toFixed(n));return`${new Intl.NumberFormat(o.i18n.locale,{minimumFractionDigits:n,maximumFractionDigits:n}).format(l)} ${r[a]}`},d=e=>{const{ref:t}=(0,i.getElement)();(0,r.S_)(t,{hasInsetLabel:x.isInlineForm});const o=(0,i.getConfig)(s),n=(0,i.getContext)();let a=null;e.size>o.maxUploadSize&&(a=o.i18n.fileTooLarge),n.allowedMimeTypes.includes(e.type)||(a=o.i18n.invalidType);const l=n.files.filter((e=>!e.error));n.maxFiles<l.length+1&&(a=o.i18n.maxFiles);const c=performance.now()+"-"+Math.random(),p=["image/gif","image/jpg","image/png","image/jpeg"].includes(e.type)&&URL.createObjectURL,d=p?"url("+URL.createObjectURL(e)+")":(e=>{const t=(0,i.getConfig)(s),o=e.type.split("/")[0],n={pdf:"pdf",doc:"doc",docx:"doc",txt:"txt",ppt:"ppt",pptx:"ppt",xls:"xls",xlsx:"xls",csv:"xls",zip:"zip",sql:"sql",cal:"cal"}[e.name.split(".").pop().toLowerCase()]||{image:"png",video:"mp4",audio:"mp3",document:"pdf",application:"txt"}[o]||"txt";return"url("+t.iconsPath+n+".svg)"})(e);n.files.push({name:e.name,formattedSize:f(e.size,2),hasIcon:!p,isUploaded:!1,hasError:!!a,id:c,url:p?d:null,mask:p?null:d,error:a}),!a&&h.uploadFile(e,c)},g=new Map,u=(e,t)=>{const o=t.loaded/t.total*100;y({progress:Math.min(o,97)},e)},m=(e,t)=>{const o=t.target;if(4===o.readyState){if(200!==o.status){const t=(0,i.getConfig)(s);return void y({error:t.i18n.uploadFailed,hasError:!0},e)}{const t=JSON.parse(o.responseText);if(t.success)return void y({file_id:t.data.file_id,isUploaded:!0,name:t.data.name,type:t.data.type,size:t.data.size,fileJson:JSON.stringify({file_id:t.data.file_id,name:t.data.name,size:t.data.size,type:t.data.type})},e)}if(o.responseText){const t=JSON.parse(o.responseText);y({error:t.message,hasError:!0},e)}}},y=(e,t)=>{const o=(0,i.getContext)(),n=o.files.findIndex((e=>e.id===t));o.files[n]=Object.assign(o.files[n],e)},{state:x,actions:h}=(0,i.store)(s,{state:{get isInlineForm(){const{ref:e}=(0,i.getElement)(),t=e.closest(".wp-block-jetpack-contact-form");return t&&t.classList.contains("is-style-outlined")||t.classList.contains("is-style-animated")},get hasFiles(){return!!(0,i.getContext)().files.length>0},get hasMaxFiles(){const e=(0,i.getContext)();return e.maxFiles<=e.files.length}},actions:{handleKeyDown:e=>{13!==e.keyCode&&32!==e.keyCode||(e.preventDefault(),h.openFilePicker(e))},openFilePicker(){const{ref:e}=(0,i.getElement)(),t=e.parentNode.querySelector(".jetpack-form-file-field");t&&(t.value="",t.click())},fileAdded(e){Array.from(e.target.files).forEach(d)},fileDropped:e=>{if(e.preventDefault(),e.dataTransfer)for(const t of Array.from(e.dataTransfer.items)){if(t.webkitGetAsEntry()?.isDirectory)return;d(t.getAsFile())}(0,i.getContext)().isDropping=!1},dragOver:e=>{(0,i.getContext)().isDropping=!0,e.preventDefault()},dragLeave:()=>{(0,i.getContext)().isDropping=!1},uploadFile:function*(e,t){const{endpoint:o,i18n:n}=(0,i.getConfig)(s),r=yield c();if(!r)return void y({error:n.uploadFailed,hasError:!0},t);const a=new XMLHttpRequest,l=new FormData,p=new AbortController;g.set(t,p),a.open("POST",o,!0),a.upload.addEventListener("progress",(0,i.withScope)(u.bind(this,t))),a.addEventListener("readystatechange",(0,i.withScope)(m.bind(this,t))),p.signal.addEventListener("abort",(()=>{a.abort()})),l.append("file",e),l.append("token",r),a.send(l)},removeFile:function*(e){e.preventDefault();const{ref:t}=(0,i.getElement)(),o=t.closest(".jetpack-form-file-field__container");(0,r.S_)(o,{hasInsetLabel:x.isInlineForm});const n=(0,i.getContext)(),a=e.target.dataset.id;if(g.has(a)){g.get(a).abort(),g.delete(a)}const l=n.files.find((e=>e.id===a));if(l&&l.url){const e=l.url.substring(4,l.url.length-1);URL.revokeObjectURL(e)}if(l&&l.file_id){const{endpoint:e}=(0,i.getConfig)(s),t=yield c();if(t){const o=new FormData;o.append("token",t),o.append("file_id",l.file_id),fetch(`${e}/remove`,{method:"POST",body:o})}}n.files=n.files.filter((e=>e.id!==a))},removeFileKeydown:e=>{13!==e.keyCode&&32!==e.keyCode||(e.preventDefault(),h.removeFile(e))}},callbacks:{focusElement:function(){const{ref:e}=(0,i.getElement)();return setTimeout((()=>{e.focus({focusVisible:!0})}),100),(0,i.withScope)((function(){const t=e.closest(".jetpack-form-file-field__container").querySelector(".jetpack-form-file-field__dropzone-inner");setTimeout((()=>{t.focus({focusVisible:!0})}),100)}))}}});