"use strict";(self.webpackChunk_automattic_woocommerce_analytics=self.webpackChunk_automattic_woocommerce_analytics||[]).push([[956],{19:(e,i,s)=>{s.d(i,{j:()=>h});var t=s(941),n=s.n(t),o=s(339),a=s(269),r=s(338),d=s(382);const c=n()("wc-analytics:analytics");class h{constructor(e,{eventQueue:i=[],commonProps:s={},features:t={},pages:n={}}){this.isInitialized=!1,this.sessionManager=e,this.apiClient=new o.O,this.eventQueue=i,this.commonProps=s,this.features=t,this.pages=n}init=()=>{if(!this.isInitialized){if(this.features.proxy&&this.apiClient.init(),this.features.sessionTracking){a.K.addConsentChangeListener(this.handleConsentChange),this.sessionManager.init();const{sessionId:e,landingPage:i,isNewSession:s}=this.sessionManager;this.features.proxy||(this.commonProps={...this.commonProps,session_id:e,landing_page:i}),s?this.maybeRecordSessionStartedEvent():this.maybeRecordEngagementEvent(),this.recordEvent("page_view")}this.maybeSetAnonId(),this.processEventQueue(),this.initListeners(),this.isInitialized=!0}};initListeners=()=>{this.pages.isAccountPage&&s.e(613).then(s.bind(s,358)).then(({initListeners:e})=>{e(this.recordEvent)})};processEventQueue=()=>{for(const e of this.eventQueue)this.recordEvent(e.eventName,e.props)};recordEvent=(e,i={})=>{if(!a.K.hasAnalyticsConsent())return void c("Skipping event recording due to lack of statistics consent: %s",e);if("string"!=typeof e||!r.bm.test(e))return void c("Skipping event recording because event name is not valid");const s={...this.commonProps,...i};this.features.proxy?(this.addClientProperties(s),this.apiClient.addEvent(e,s)):this.fireDirectPixel(e,s),this.isInitialized&&this.maybeRecordEngagementEvent()};fireDirectPixel=(e,i)=>{window._wca?(this.features.ch&&r.S6.includes(e)?i.ch=1:delete i.ch,c('Recording event via _wca: "%s" with props %o',e,i),i._en=`${r.CS}${e}`,window._wca.push(i)):c("Skipping event recording because _wca is not defined")};addClientProperties=e=>{const i=new Date;e._ts=i.getTime(),e._tz=i.getTimezoneOffset()/60;const s=window.navigator,t=window.screen;e._lg=s.language,e._pf=navigator?.platform,e._ht=t.height,e._wd=t.width;const n=void 0!==window.pageXOffset?window.pageXOffset:(document.documentElement||document.body).scrollLeft,o=void 0!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body).scrollTop;e._sx=void 0!==n?n:0,e._sy=void 0!==o?o:0,void 0!==document.location&&(e._dl=document.location.toString()),void 0!==document.referrer&&(e._dr=document.referrer)};maybeRecordSessionStartedEvent=()=>{this.features.sessionTracking&&this.sessionManager.isNewSession&&this.sessionManager.sessionId&&this.recordEvent("session_started")};maybeRecordEngagementEvent=()=>{this.features.sessionTracking&&!this.sessionManager.isEngaged&&this.sessionManager.sessionId&&(this.sessionManager.setEngaged(),this.recordEvent("session_engagement"))};handleConsentChange=e=>{e?this.sessionManager.sessionId||this.sessionManager.init():this.sessionManager.clearSession()};maybeSetAnonId(){if(!(0,d.R)("tk_ai")){const e=(0,d.I)(18),i=new Date(Date.now()+31536e6).toUTCString();document.cookie=`tk_ai=${e}; path=/; secure; samesite=strict; expires=${i}`}}}},338:(e,i,s)=>{s.d(i,{BU:()=>d,CS:()=>n,Op:()=>c,RV:()=>a,S6:()=>h,bm:()=>o,xE:()=>r,z4:()=>t});const t="woocommerceanalytics_session",n="woocommerceanalytics_",o=/^[a-z_][a-z0-9_]*$/,a="woocommerce-analytics/v1",r="track",d=10,c=1e3,h=["session_started","session_engagement","product_view","cart_view","add_to_cart","remove_from_cart","checkout_view","product_checkout","product_purchase","order_confirmation_view","search","page_view"]},339:(e,i,s)=>{s.d(i,{O:()=>c});var t=s(455),n=s.n(t),o=s(941),a=s.n(o),r=s(338);const d=a()("wc-analytics:api-client");class c{eventQueue=[];debounceTimer=null;isInitialized=!1;init=()=>{this.isInitialized||(d("API client initialized"),window.addEventListener("beforeunload",this.flush),window.addEventListener("pagehide",this.flush),this.isInitialized=!0)};addEvent=(e,i={})=>{if(!this.isInitialized)return void d("API client not initialized, skipping event: %s",e);d('Recording event via API: "%s" with props %o',e,i);const s={event_name:e,properties:i};this.eventQueue.push(s),d("Event added to queue: %s (queue size: %d)",e,this.eventQueue.length),this.debouncedSend(),this.eventQueue.length>=r.BU&&this.flush()};debouncedSend=()=>{this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=window.setTimeout(()=>{this.flush()},r.Op)};flush=()=>{if(this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null),0===this.eventQueue.length)return;const e=[...this.eventQueue];this.eventQueue=[],this.sendEvents(e)};sendEvents=async e=>{if(0!==e.length)try{d("Sending %d events to API",e.length);const i=await n()({path:`/${r.RV}/${r.xE}`,method:"POST",data:e});d("API response received: %o",i),i.success||d("Some events failed to send: %o",i.results)}catch(i){d("Failed to send events to API: %o",i),this.eventQueue.unshift(...e)}}}},382:(e,i,s)=>{function t(e){const i=`; ${document.cookie}`.split(`; ${e}=`);return 2===i.length&&i.pop()?.split(";").shift()||null}function n(e){let i;if(window.crypto&&window.crypto.getRandomValues)i=new Uint8Array(e),window.crypto.getRandomValues(i);else for(let s=0;s<e;++s)i[s]=Math.floor(256*Math.random());return btoa(String.fromCharCode(...i))}s.d(i,{I:()=>n,R:()=>t})},633:(e,i,s)=>{s.r(i);var t=s(19),n=s(841);!function(){const e=new n.A;new t.j(e,{eventQueue:window.wcAnalytics.eventQueue,commonProps:window.wcAnalytics.commonProps,features:window.wcAnalytics.features,pages:window.wcAnalytics.pages}).init()}()},841:(e,i,s)=>{s.d(i,{A:()=>o});var t=s(338),n=s(382);class o{sessionId=null;landingPage=null;isEngaged=!1;isNewSession=!1;isInitialized=!1;init=()=>{this.isInitialized||(this.loadOrCreateSession(),this.isInitialized=!0)};loadOrCreateSession(){const e=this.getSessionCookie();e&&e.session_id?(this.sessionId=e.session_id,this.landingPage=e.landing_page||null,this.isEngaged=e.is_engaged||!1,this.isNewSession=!1):this.createNewSession()}createNewSession(){this.isNewSession=!0;const e={session_id:this.generateRandomUuid(),landing_page:JSON.stringify(window.wcAnalytics?.breadcrumbs||[]),expires:this.getSessionExpirationTime()};this.setSessionCookie(e)&&(this.sessionId=e.session_id,this.landingPage=e.landing_page,this.isEngaged=!1)}getSessionCookie(){const e=(0,n.R)(t.z4);if(!e)return null;try{return JSON.parse(decodeURIComponent(e))}catch(e){return console.error("Error parsing session cookie",e),null}}setSessionCookie(e){const i=encodeURIComponent(JSON.stringify(e)),s=e.expires||this.getSessionExpirationTime();document.cookie=`${t.z4}=${i}; expires=${s}; path=/; secure; samesite=strict`;return(0,n.R)(t.z4)===i}getSessionExpirationTime(){const e=Date.now()+18e5,i=new Date;i.setUTCDate(i.getUTCDate()+1),i.setUTCHours(0,0,0,0);const s=Math.min(e,i.getTime());return new Date(s).toUTCString()}generateRandomUuid(){if("undefined"!=typeof crypto&&crypto.randomUUID)return crypto.randomUUID();if("undefined"!=typeof crypto&&crypto.getRandomValues){const e=new Uint8Array(16);crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;const i=Array.from(e,e=>e.toString(16).padStart(2,"0")).join("");return[i.slice(0,8),i.slice(8,12),i.slice(12,16),i.slice(16,20),i.slice(20,32)].join("-")}return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const i=Math.floor(16*Math.random());return("x"===e?i:i%4+8).toString(16)})}setEngaged(){if(this.isEngaged)return;const e=this.getSessionCookie();e&&e.session_id&&(e.is_engaged=!0,this.setSessionCookie(e)),this.isEngaged=!0}clearSession(){document.cookie=`${t.z4}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; secure; samesite=strict`,this.sessionId=null,this.landingPage=null,this.isEngaged=!1,this.isNewSession=!1,this.isInitialized=!1}}}}]);