var R=Object.defineProperty;var w=Object.getOwnPropertySymbols;var S=Object.prototype.hasOwnProperty,$=Object.prototype.propertyIsEnumerable;var _=(a,t,r)=>t in a?R(a,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):a[t]=r,p=(a,t)=>{for(var r in t||(t={}))S.call(t,r)&&_(a,r,t[r]);if(w)for(var r of w(t))$.call(t,r)&&_(a,r,t[r]);return a};import{_ as f,aa as I,$ as y,c as u,q as b,b_ as F}from"./main-381.js";import{a4 as v}from"./bf-433-81.js";const E=(a,t,r,h,i,e,s,d,o)=>{let l=p({},t);if(s){const c=p({},d);c[a.target.name]="",o(p({},c))}switch(l[a.target.name]=a.target.value,a.target.name){case"spreadsheetId":l=A(l,h,r,i,e);break;case"worksheetName":l=W(l,h,r,i,e);break}r(p({},l))},A=(a,t,r,h,i)=>{var s,d,o,l,c,g,n,k,m;const e=b(a);return e.worksheetName="",e.headerRow="A1",e.field_map=[{formField:"",googleSheetField:""}],(d=(s=e==null?void 0:e.default)==null?void 0:s.worksheets)!=null&&d[a.spreadsheetId]?Object.keys((l=(o=e==null?void 0:e.default)==null?void 0:o.worksheets)==null?void 0:l[a.spreadsheetId]).length===1&&(e.worksheetName=(g=(c=e==null?void 0:e.default)==null?void 0:c.worksheets)==null?void 0:g[a.spreadsheetId][0].properties.title,(m=(k=(n=e==null?void 0:e.default)==null?void 0:n.worksheets)==null?void 0:k.headers)!=null&&m[e.worksheetName]||D(t,e,r,h,i)):N(t,e,r,h,i),e},W=(a,t,r,h,i)=>{var s,d,o;const e=p({},a);return e.headerRow="A1",e.field_map=[{formField:"",googleSheetField:""}],(o=(d=(s=e==null?void 0:e.default)==null?void 0:s.worksheets)==null?void 0:d.headers)!=null&&o[a.worksheetName]||D(t,e,r,h,i),e},P=(a,t,r,h,i)=>{h(!0);const e={formID:a,id:t.id,clientId:t.clientId,clientSecret:t.clientSecret,tokenDetails:t.tokenDetails,ownerEmail:t.ownerEmail};u(e,"bitforms_gsheet_refresh_spreadsheets").then(s=>{if(s&&s.success){const d=p({},t);d.default||(d.default={}),s.data.spreadsheets&&(d.default.spreadsheets=s.data.spreadsheets),s.data.tokenDetails&&(d.tokenDetails=s.data.tokenDetails),i({show:!0,msg:f("Spreadsheet refreshed")}),r(p({},d))}else s&&s.data&&s.data.data||!s.success&&typeof s.data=="string"?i({show:!0,msg:F(f("Spreadsheet refresh failed Cause: %s. please try again"),s.data.data||s.data)}):i({show:!0,msg:f("Spreadsheet refresh failed. please try again")});h(!1)}).catch(()=>h(!1))},N=(a,t,r,h,i)=>{const{spreadsheetId:e}=t;if(!e)return;h(!0);const s={formID:a,spreadsheetId:e,clientId:t.clientId,clientSecret:t.clientSecret,tokenDetails:t.tokenDetails};u(s,"bitforms_gsheet_refresh_worksheets").then(d=>{if(d&&d.success){const o=p({},t);d.data.worksheets&&(o.default.worksheets||(o.default.worksheets={}),o.default.worksheets[e]=d.data.worksheets),d.data.tokenDetails&&(o.tokenDetails=d.data.tokenDetails),i({show:!0,msg:f("Worksheets refreshed")}),r(p({},o))}else i({show:!0,msg:f("Worksheets refresh failed. please try again")});h(!1)}).catch(()=>h(!1))},D=(a,t,r,h,i)=>{const{spreadsheetId:e,worksheetName:s,header:d,headerRow:o}=t;if(!e&&!s&&!d&&!o)return;h(!0);const l={formID:a,spreadsheetId:e,worksheetName:s,header:d,headerRow:o,clientId:t.clientId,clientSecret:t.clientSecret,tokenDetails:t.tokenDetails};u(l,"bitforms_gsheet_refresh_worksheet_headers").then(c=>{var g;if(c&&c.success){const n=p({},t);((g=c.data.worksheet_headers)==null?void 0:g.length)>0?(n.default.headers||(n.default.headers={}),n.default.headers[e]||(n.default.headers[e]={}),n.default.headers[e][s]||(n.default.headers[e][s]={}),n.default.headers[e][s][o]=c.data.worksheet_headers,c.data.tokenDetails&&(n.tokenDetails=c.data.tokenDetails),i({show:!0,msg:f("Worksheet Headers refreshed")})):i({show:!0,msg:f("No Worksheet headers found. Try changing the header row number or try again")}),c.data.tokenDetails&&(n.tokenDetails=c.data.tokenDetails),r(p({},n))}else i({show:!0,msg:f("Worksheet Headers refresh failed. please try again")});h(!1)}).catch(()=>h(!1))},M=(a,t,r,h,i,e)=>{if(!a.clientId||!a.clientSecret){r({clientId:a.clientId?"":f("Client ID cann't be empty"),clientSecret:a.clientSecret?"":f("Secret key cann't be empty")});return}i(!0);const s="https://www.googleapis.com/auth/drive",d=I(y),o=`https://accounts.google.com/o/oauth2/v2/auth?scope=${s}&access_type=offline&prompt=consent&response_type=code&state=${encodeURIComponent(window.location.href)}/redirect&redirect_uri=${encodeURIComponent(d.googleRedirectURL)}&client_id=${a.clientId}`,l=window.open(o,"googleSheet","width=400,height=609,toolbar=off"),c=setInterval(()=>{if(l.closed){clearInterval(c);let g={},n=!1;const k=localStorage.getItem("__bitforms_googleSheet");if(k&&(n=!0,g=JSON.parse(k),localStorage.removeItem("__bitforms_googleSheet")),!g.code||g.error||!g||!n){const m=g.error?`Cause: ${g.error}`:"";e({show:!0,msg:`${f("Authorization failed")} ${m}. ${f("please try again")}`}),i(!1)}else{const m=p({},a);m.accountServer=g["accounts-server"],U(g,m,t,h,i,e)}}},500)},U=(a,t,r,h,i,e)=>{const s=p({},a);s.clientId=t.clientId,s.clientSecret=t.clientSecret;const d=I(y);s.redirectURI=d.googleRedirectURL,u(s,"bitforms_gsheet_generate_token").then(o=>o).then(o=>{if(o&&o.success){const l=p({},t);l.tokenDetails=o.data,r(l),v(l),h(!0),e({show:!0,msg:f("Authorized Successfully")})}else o&&o.data&&o.data.data||!o.success&&typeof o.data=="string"?e({show:!0,msg:`${f("Authorization failed Cause:")}${o.data.data||o.data}. ${f("please try again")}`}):e({show:!0,msg:f("Authorization failed. please try again")});i(!1)})},O=a=>!((a.field_map?a.field_map.filter(r=>!r.formField&&!r.googleSheetField):[]).length>0);export{E as a,N as b,D as c,O as d,M as h,P as r};
