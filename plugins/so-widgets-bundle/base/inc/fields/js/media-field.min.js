!function(t){const e=function(e){const i=t(this),n=i.find("> .media-field-wrapper"),s=i.find(".siteorigin-widget-input").not(".media-fallback-external"),o=i.find(".media-fallback-external");if(i.attr("data-initialized"))return;let a;i.attr("data-initialized",!0),n.find(".media-upload-button").on("click",function(e){if(e.preventDefault(),void 0===window.top.wp.media)return;const n=t(this);let o=t(this).data("frame");if(o)return o.open(),!1;o=window.top.wp.media({title:n.data("choose"),library:{type:n.data("library").split(",").map(function(t){return t.trim()})},button:{text:n.data("update"),close:!1}}),o.on("open",function(){const t=o.state().get("selection"),e=i.find('.siteorigin-widget-input[type="hidden"]').val();e&&t.add(window.top.wp.media.attachment(e))}),n.data("frame",o),o.on("select",function(){const t=o.state().get("selection").first().attributes;i.find(".current .thumbnail").attr("title",t.title),i.find(".current .title").html(t.title),s.val(t.id),s.trigger("change",{silent:!0});const e=i.find(".current .thumbnail");void 0!==t.sizes?void 0!==t.sizes.thumbnail?e.attr("src",t.sizes.thumbnail.url).fadeIn():e.attr("src",t.sizes.full.url).fadeIn():e.attr("src",t.icon).fadeIn(),i.find(".media-remove-button").removeClass("remove-hide").attr("tabindex",0),o.close()}),o.open()}),i.find("a.media-remove-button").on("click",function(e){e.preventDefault(),s.val(""),i.find(".current .title").empty(),s.trigger("change",{silent:!0});const n=i.find(".current .thumbnail");n.attr("src",""),n.fadeOut("fast"),t(this).addClass("remove-hide").attr("tabindex",-1)});let r=null;const d=function(){if(!a)return;const t=a.find(".so-widgets-image-results");if(0===t.length)return;const e=t.width(),i=Math.floor(e/276),n=(e-276*i)/i+260;t.find(".so-widgets-result-image").css({width:n+"px",height:n/1.4+"px"})};t(window).on("resize",d);n.find(".find-image-button").on("click",function(e){e.preventDefault(),t(".so-importing-image").removeClass("so-importing-image"),i.addClass("so-importing-image"),r=i,function(){if(!a){a=t(t("#so-widgets-bundle-tpl-image-search-dialog").html().trim()).appendTo(window.top.document.body),a.find(".close").on("click keyup",function(e){("keyup"!=e.type||window.sowbForms.isEnter(e))&&(a.hide(),a.hasClass("so-widgets-importing")||(t(".so-importing-image").removeClass("so-importing-image"),r=null))});const e=a.find(".so-widgets-image-results"),i=function(i,n){a.find(".so-widgets-results-loading").fadeIn("fast"),a.find(".so-widgets-results-loading strong").html(a.find(".so-widgets-results-loading strong").data("loading")),a.find(".so-widgets-results-more").hide(),t.get(ajaxurl,{action:"so_widgets_image_search",q:i,page:n,_sononce:a.find('input[name="_sononce"]').val()},function(s){s.error?alert(s.message):(e.removeClass("so-loading"),t.each(s.items,function(i,n){const s=t(t("#so-widgets-bundle-tpl-image-search-result").html().trim()).appendTo(e).addClass("source-"+n.source).find(".so-widgets-result-image");s.css("background-image","url("+n.thumbnail+")"),s.data("thumbnail",n.thumbnail),s.data("preview",n.preview),n.url&&s.attr({href:n.url,target:"_blank"}),n.full_url&&(s.data({full_url:n.full_url,import_signature:n.import_signature}),s.attr("href",n.full_url)),"shutterstock"===n.source&&s.append(t("#so-widgets-bundle-tpl-image-search-result-sponsored").html())}),1===n&&(a.find("#so-widgets-image-search-suggestions ul").empty(),t.each(s.keywords,function(e,i){a.find("#so-widgets-image-search-suggestions").show(),a.find("#so-widgets-image-search-suggestions ul").append(t("<li></li>").append(t('<a href="#"></a>').html(i).data("keyword",i)))})),a.find(".so-widgets-results-loading").fadeOut("fast"),d(),a.find(".so-widgets-results-more").show().find("button").data({query:i,page:n+1}))})};let n;a.find("#so-widgets-image-search-form").on("submit",function(t){t.preventDefault();const n=a.find(".so-widgets-search-input").val();e.empty(),""!==n&&i(n,1)}),a.on("click",".so-keywords-list a",function(e){e.preventDefault();const i=t(this).trigger("blur");a.find(".so-widgets-search-input").val(i.data("keyword")),a.find("#so-widgets-image-search-form").trigger("submit")}),a.find(".so-widgets-results-more button").on("click",function(){const e=t(this);i(e.data("query"),e.data("page"))}),a.on("click",".so-widgets-result-image",function(e){const i=t(this);if(i.data("full_url")&&(e.preventDefault(),confirm(a.data("confirm-import")))){a.addClass("so-widgets-importing");const e=t("#post_ID").val();null===e&&(e=""),t.get(ajaxurl,{action:"so_widgets_image_import",full_url:i.data("full_url"),import_signature:i.data("import_signature"),post_id:e,_sononce:a.find('input[name="_sononce"]').val()},function(t){if(!1===t.error){const e=r;if(e&&e.length){const i=e.find(".siteorigin-widget-input").not(".media-fallback-external");i.val(t.attachment_id),i.trigger("change");const n=e.find(".current .thumbnail");n.attr("src",t.thumb),n.fadeIn(),e.find(".media-remove-button").removeClass("remove-hide").attr("tabindex",0),e.removeClass("so-importing-image"),r=null}a.hide()}else alert(t.message),a.find(".so-widgets-results-loading").hide();a.removeClass("so-widgets-importing"),a.find("#so-widgets-image-search-frame").removeClass("so-widgets-importing")}),a.find(".so-widgets-results-loading").fadeIn("fast"),a.find(".so-widgets-results-loading strong").html(a.find(".so-widgets-results-loading strong").data("importing")),a.find(".so-widgets-results-more").hide(),a.find("#so-widgets-image-search-frame").addClass("so-widgets-importing")}});const s=a.find(".so-widgets-preview-window");let o,l;a.on("mouseenter",".so-widgets-result-image",function(){const e=t(this),i=e.data("preview");clearTimeout(n),n=setTimeout(function(){let n=1,o=1;i[1]>.33*t(window).outerWidth()&&(n=.33*t(window).outerWidth()/i[1]),i[2]>.5*t(window).outerHeight()&&(o=.5*t(window).outerHeight()/i[2]);let r=Math.min(n,o);r>1&&(r=1),s.show().find(".so-widgets-preview-window-inside").css({"background-image":"url("+e.data("thumbnail")+")",width:i[1]*r+"px",height:i[2]*r+"px"}).append(t("<img />").attr("src",i[0])),a.trigger("mousemove")},1e3)}).on("mouseleave",".so-widgets-result-image",function(){s.hide().find("img").remove(),clearTimeout(n)}),a.on("mousemove",function(e){if(e.clientX&&(o=e.clientX),e.clientY&&(l=e.clientY),s.is(":visible")){const e=s.outerHeight(),i=s.outerWidth(),n=t(window).outerHeight(),a=t(window).outerWidth();let r=l-e/2;r=Math.max(r,10),r=Math.min(r,n-10-e);const d=o<a/2?o+15:o-15-i;s.css({top:r+"px",left:d+"px"})}})}a.show(),a.find(".so-widgets-search-input").trigger("focus")}()}),s.on("change",function(t,e){if(!e||!e.silent){const t=s.val();if(t){const e=i.find(".current .thumbnail"),n=window.top.wp.media.attachment(t);n.fetch().done(function(){if(n.has("sizes")){const t=n.get("sizes");void 0!==t.thumbnail?e.attr("src",t.thumbnail.url).fadeIn():e.attr("src",t.full.url).fadeIn()}else e.attr("src",n.get("icon")).fadeIn();i.find(".media-remove-button").removeClass("remove-hide").attr("tabindex",0)})}else i.find("a.media-remove-button").trigger("click")}void 0!==e&&e.external||o.trigger("change",{internal:!0})}),o.on("change",function(e,i){t(e.currentTarget).hasClass("media-fallback-external")||void 0!==i&&i.internal||s.trigger("change",{external:!0})})};window.top===window.self&&"string"==typeof pagenow&&"site-editor"!==pagenow&&t(document).on("sowsetupformfield",".siteorigin-widget-field-type-media",e),window.addEventListener("message",function(i){i.data&&"sowbBlockFormInit"===i.data.action&&t(".siteorigin-widget-field-type-media").each(function(){t(this).attr("data-initialized")||e.call(this)})})}(jQuery);