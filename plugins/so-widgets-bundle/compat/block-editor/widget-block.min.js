!function(t,e,i,o,s){const n=i.createElement,r=t.registerBlockType,a=s.BlockControls,{Component:d,useMemo:l}=i,{Toolbar:c,ToolbarButton:g,Placeholder:w,Button:u,Spinner:b}=o,{__:p,sprintf:m}=e,h=t=>{let e="";return t.hasOwnProperty("responseJSON")?e=t.responseJSON.message:t.hasOwnProperty("responseText")&&(e=t.responseText),e},k=["sowb/siteorigin-widget-googlemap-widget","sowb/siteorigin-widget-icon-widget"],f=(t,e,i,o=!1,s=!1)=>{if(e)return;i({loadingWidgetPreview:!0,widgetPreviewHtml:null});const n="object"==typeof wp.data.select("core/editor")&&"object"==typeof wp.data.dispatch("core/editor");n&&wp.data.dispatch("core/editor").lockPostSaving();jQuery.post({url:sowbBlockEditorAdmin.restUrl+"sowb/v1/widgets/previews",beforeSend:t=>{t.setRequestHeader("X-WP-Nonce",sowbBlockEditorAdmin.nonce)},data:{anchor:t.attributes.anchor,widgetClass:s,widgetData:o||(t.attributes.widgetData||{})}}).done(e=>{let o=!1;e.html&&(o=!!k.includes(t.name)||(t=>{const e=jQuery("<div>"+t+"</div>");let i=!1;const o=e.find("div:first-of-type");return o.length>0&&(""!==o.text().trim()||o.find("img, video, a").length>0)&&(i=!0),e.remove(),i})(e.html)),o||(e.html='<div class="so-widget-preview-empty">'+p("No widget preview available.","so-widgets-bundle")+"</div>"),i({widgetPreviewHtml:e.html,previewInitialized:!1}),t.setAttributes({widgetMarkup:e.html,widgetIcons:e.icons}),n&&wp.data.dispatch("core/editor").unlockPostSaving()}).fail(t=>{i({widgetFormHtml:"<div>"+h(t)+"</div>"})}).always(()=>{i({loadingWidgetPreview:!1})})},v=({props:t,widget:e})=>l(()=>n(y,{...t,widget:e}),[t,e]);class y extends d{constructor(t){super(t),this.initialState={editing:void 0===t.attributes.widgetData,formInitialized:!1,loadingForm:!1,loadingWidgetPreview:!1,previewInitialized:!1,widgetFormHtml:"",widgetPreviewHtml:"",widgetSettingsChanged:!1},this.state={...this.initialState,isStillMounted:!0},t.attributes.widgetClass||this.props.setAttributes({widgetClass:t.widget.class})}componentDidMount(){this.setState({...this.initialState,isStillMounted:!0}),this.loadWidgetData()}componentWillUnmount(){this.setState({...this.initialState,isStillMounted:!1})}componentDidUpdate(t,e){this.state.isStillMounted&&(this.state.editing===e.editing&&this.props.attributes.widgetData===t.attributes.widgetData||(this.setState({widgetSettingsChanged:!0,widgetPreviewHtml:null,previewInitialized:!1}),this.loadWidgetData()))}loadWidgetData(){if(!this.state.isStillMounted)return;const{editing:t,widgetFormHtml:e,loadingForm:i,loadingWidgetPreview:o}=this.state,{attributes:s}=this.props;if(t||!s.widgetData){return void(!e.length&&!i&&(this.setState({loadingForm:!0}),jQuery.post({url:sowbBlockEditorAdmin.restUrl+"sowb/v1/widgets/forms",beforeSend:t=>{t.setRequestHeader("X-WP-Nonce",sowbBlockEditorAdmin.nonce)},data:{widgetClass:this.props.widget.class,widgetData:s.widgetData}}).done(t=>{this.setState({widgetFormHtml:t}),setTimeout(()=>{this.setState({loadingForm:!1,formInitialized:!1})},0)}).fail(t=>{this.setState({widgetFormHtml:"<div>"+h(t)+"</div>"})})))}!o&&!t&&(this.props.setAttributes({widgetMarkup:null,widgetIcons:null}),f(this.props,this.state.loadingWidgetPreview,this.setState.bind(this),!1,this.props.widget.class))}render(){const{editing:t,widgetFormHtml:e,loadingForm:i,widgetPreviewHtml:o,loadingWidgetPreview:s,previewInitialized:r}=this.state,{attributes:d}=this.props;return n("div",null,t||!d.widgetData?[!!e&&n(a,{key:"controls"},n(c,{label:p("Preview widget."+t,"so-widgets-bundle")},n(g,{className:"components-icon-button components-toolbar__control",label:p("Preview widget.","so-widgets-bundle"),onClick:()=>this.setState({editing:!1}),icon:"visibility"}))),n(w,{key:"placeholder",className:"so-widget-placeholder",label:this.props.widget.name,instructions:this.props.widget.description},i?n("div",{className:"so-widgets-spinner-container"},n("span",null,n(b))):n("div",{className:"so-widget-block-container",dangerouslySetInnerHTML:{__html:e},ref:()=>((t,e,i)=>{const o=jQuery('[data-block="'+t.clientId+'"]').find(".siteorigin-widget-form-main");if(o.length>0&&!e.formInitialized){o.siblings(".siteorigin-widget-preview").find("> a").on("click",(function(t){t.stopImmediatePropagation(),i({editing:!1,previewInitialized:!1,widgetPreviewHtml:!1})})),o.data("backupDisabled",!0),o.sowSetupForm(),t.attributes.widgetData?sowbForms.setWidgetFormValues(o,t.attributes.widgetData):t.setAttributes({widgetData:sowbForms.getWidgetFormValues(o)}),o.on("change",()=>{var e=sowbForms.getWidgetFormValues(o);t.setAttributes({widgetData:e})}),i({formInitialized:!0})}})(this.props,this.state,this.setState.bind(this),this.props.widget.class)}))]:[n(a,{key:"controls"},n(c,{label:p("Edit widget.","so-widgets-bundle")},n(g,{className:"components-icon-button components-toolbar__control",label:p("Edit widget.","so-widgets-bundle"),onClick:()=>this.setState({editing:!0,loadingForm:!1,widgetFormHtml:"",formInitialized:!1}),icon:"edit"}))),n("div",{key:"preview",className:"so-widget-preview-container"},s?n("div",{className:"so-widgets-spinner-container"},n("span",null,n(b))):n("div",{dangerouslySetInnerHTML:{__html:o},ref:()=>{r||(jQuery(window.sowb).trigger("setup_widgets",{preview:!0}),this.setState({previewInitialized:!0}))}}))])}}sowbBlockEditorAdmin.widgets.forEach((function(t){r("sowb/"+t.blockName,{title:t.name,description:t.description,icon:function(){return t.icon?n("img",{className:"widget-icon so-widget-icon so-block-editor-icon",src:t.icon,alt:t.name}):n("span",{className:"widget-icon so-widget-icon so-block-editor-icon so-widget-icon-default"})},category:"widgets",keywords:t.keywords?t.keywords:"",supports:{html:!1,anchor:!0},attributes:{widgetClass:{type:"string"},anchor:{type:"string"},widgetData:{type:"object"},widgetMarkup:{type:"string"},widgetIcons:{type:"array"}},edit:e=>n(v,{props:e,widget:t}),save:function(t){return null}})})),r("sowb/widget-block",{title:p("Legacy SiteOrigin Widget","so-widgets-bundle"),description:p("This block is intended as a legacy placeholder.","so-widgets-bundle"),attributes:{widgetClass:{type:"string"},anchor:{type:"string"},widgetData:{type:"object"},widgetMarkup:{type:"string"},widgetIcons:{type:"array"},widgetNotFound:{type:"boolean"}},icon:function(){return n("span",{className:"widget-icon so-widget-icon so-block-editor-icon so-widget-icon-default"})},edit:function(t){const[e,o]=i.useState(!1),[s,r]=i.useState(!0);return wp.element.useEffect(()=>{const t=wp.data.subscribe(()=>{if("function"!=typeof wp.data.select("core").canUser)return;s&&r(!1);const e=wp.data.select("core").canUser("update",{kind:"root",name:"site"});"boolean"==typeof e&&(o(e),t())});return()=>t()},[]),t.attributes.widgetNotFound?n(w,{label:p("SiteOrigin Widget","so-widgets-bundle")},n("p",null,m(p("The widget for %s cannot be found.","so-widgets-bundle"),t.attributes.widgetClass))):s?n("div",{className:"so-widgets-spinner-container"},n("span",null,n(b))):n(w,{label:p("Legacy SiteOrigin Widget","so-widgets-bundle")},n("p",{dangerouslySetInnerHTML:{__html:sowbBlockEditorAdmin.legacyNotice}}),e?n(u,{isPrimary:!0,onClick:()=>{r(!0),setTimeout(()=>{sowbBlockEditorAdmin.consent=!0,sowbBlockEditorAdmin.consentGiven=!0,sowbMigrateOldBlocks()},0),jQuery.post(ajaxurl,{action:"so_widgets_block_migration_notice_consent",nonce:sowbBlockEditorAdmin.migrationNotice})}},p("Migrate to New Block Format","so-widgets-bundle")):n("span",null,p("Please contact your site administrator to migrate this block.","so-widgets-bundle")))},save:function(){return null}})}(window.wp.blocks,window.wp.i18n,window.wp.element,window.wp.components,window.wp.blockEditor);const sowbFindLegacyBlocks=t=>t.reduce((t,e)=>{if("core/widget-area"===e.name){return wp.data.select("core/block-editor").getBlocks(e.clientId).forEach(e=>{"sowb/widget-block"===e.name&&t.push(e)}),t}return"sowb/widget-block"===e.name&&t.push(e),e.innerBlocks&&e.innerBlocks.length>0&&t.push(...sowbFindLegacyBlocks(e.innerBlocks)),t},[]),sowbIsWidgetActive=t=>sowbBlockEditorAdmin.widgets.find(e=>e.class===t);let sowbMigrateBlockSubscribe=!1;const sowbMigrateOldBlocks=()=>{const t=wp.data.select("core/block-editor").getBlocks();if(0===t.length)return;const e=sowbFindLegacyBlocks(t);if(0!==e.length){if(sowbBlockEditorAdmin.consent)return e.forEach(t=>{try{if(e=t.attributes.widgetClass,!sowbBlockEditorAdmin.widgets.find(t=>t.class===e)){const e={...t.attributes};return e.widgetNotFound=!0,void wp.data.dispatch("core/block-editor").updateBlock(t.clientId,{attributes:e})}const i=wp.blocks.createBlock("sowb/"+t.attributes.widgetClass.toLowerCase().replace(/_/g,"-"),t.attributes);i&&wp.data.dispatch("core/block-editor").replaceBlock(t.clientId,i)}catch(t){console.error("SiteOrigin Widget Block migration failed:",t)}var e}),!sowbBlockEditorAdmin.consentGiven&&sowbRemoveLegacyWidgetBlock();"function"==typeof sowbMigrateBlockSubscribe&&sowbMigrateBlockSubscribe()}},sowbRemoveLegacyWidgetBlock=()=>(setTimeout(()=>{"function"==typeof sowbMigrateBlockSubscribe&&sowbMigrateBlockSubscribe()},0),!1),sowbIsMissingBlockSowb=t=>"core/missing"===t.name&&t.isValid&&t.attributes&&t.attributes.originalName.startsWith("sowb/"),sowbFindInactiveBlock=t=>t.reduce((t,e)=>{if("core/widget-area"===e.name){return wp.data.select("core/block-editor").getBlocks(e.clientId).forEach(e=>{sowbIsMissingBlockSowb(e)&&t.push(e)}),t}return sowbIsMissingBlockSowb(e)&&t.push(e),e.innerBlocks&&e.innerBlocks.length>0&&t.push(...sowbFindInactiveBlock(e.innerBlocks)),t},[]);if(jQuery((function(t){if(!t("body.block-editor-page").length)return;sowbBlockEditorAdmin.consent&&(sowbMigrateBlockSubscribe=wp.data.subscribe(sowbMigrateOldBlocks));const e=wp.data.subscribe(()=>{const t=wp.data.select("core/block-editor").getBlocks();if(0===t.length)return;const i=sowbFindInactiveBlock(t);i.length&&(setTimeout(()=>{(t=>{t.forEach(t=>{const e=document.querySelector(`[data-block="${t.clientId}"] .block-editor-warning__message`);e&&(e.innerHTML=sprintf(wp.i18n.__('The "%s" block is currently not available. The plugin or theme that powers the block might be deactivated or not installed. You can leave it as is or remove it. %sRead our troubleshooting guide for more details%s.',"so-widgets-bundle"),`<strong>${t.attributes.originalName}</strong>`,'<a href="https://siteorigin.com/widgets-bundle/troubleshooting/" target="_blank" rel="noopener noreferrer">',"</a>"))})})(i)},0),e())})})),"undefined"!=typeof adminpage&&"widgets-php"!=adminpage&&"function"==typeof wp.data.select){let t=!1;wp.data.subscribe((function(){if(!t&&"object"==typeof wp.data.select("core/editor")&&wp.data.select("core/editor").isSavingPost()){t=!0;var e=setInterval((function(){if(!wp.data.select("core/editor").isSavingPost()&&!wp.data.select("core/editor").isAutosavingPost()&&wp.data.select("core/editor").didPostSaveRequestSucceed()){clearInterval(e);for(var i=!0,o=wp.data.select("core/block-editor").getBlocks(),s=0;s<o.length;s++)o[s].name.startsWith("sowb/")&&o[s].isValid&&($form=jQuery("#block-"+o[s].clientId).find(".so-widget-placeholder"),sowbForms.validateFields($form,i)||(i=!1),$form.find(".siteorigin-widget-field-is-required input").on("change",(function(){sowbForms.validateFields($form)})));t=!1}}),250)}}))}