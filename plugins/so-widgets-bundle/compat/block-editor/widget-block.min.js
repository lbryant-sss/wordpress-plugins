!async function(e,t,i,o,s){const n=i.createElement,r=e.registerBlockType,a=s.BlockControls,{Component:d,useMemo:l}=i,{ToolbarGroup:c,ToolbarButton:g,Placeholder:w,Button:u,Spinner:b}=o,{__:m,sprintf:p}=t,{updateCategory:h}=e,k=e=>{let t="";return e.hasOwnProperty("responseJSON")?t=e.responseJSON.message:e.hasOwnProperty("responseText")&&(t=e.responseText),t},f=["sowb/siteorigin-widget-googlemap-widget","sowb/siteorigin-widget-icon-widget"],v=e=>e.icon?e.icon.trim().startsWith("<svg")?n("span",{className:"widget-icon so-widget-icon so-block-editor-icon",dangerouslySetInnerHTML:{__html:e.icon}}):n("img",{className:"widget-icon so-widget-icon so-block-editor-icon",src:e.icon,alt:e.name}):n("span",{className:"widget-icon so-widget-icon so-block-editor-icon",dangerouslySetInnerHTML:{__html:sowbBlockEditorAdmin.defaultIcon}}),y=(e,t,i,o=!1,s=!1)=>{if(t)return;i({loadingWidgetPreview:!0,widgetPreviewHtml:null});const n="object"==typeof wp.data.select("core/editor")&&"object"==typeof wp.data.dispatch("core/editor");n&&wp.data.dispatch("core/editor").lockPostSaving();jQuery.post({url:sowbBlockEditorAdmin.restUrl+"sowb/v1/widgets/previews",beforeSend:e=>{e.setRequestHeader("X-WP-Nonce",sowbBlockEditorAdmin.nonce)},data:{anchor:e.attributes.anchor,widgetClass:s,widgetData:o||(e.attributes.widgetData||{})}}).done(t=>{let o=!1;t.html&&(o=!!f.includes(e.name)||(e=>{const t=jQuery("<div>"+e+"</div>");let i=!1;const o=t.find("div:first-of-type");return o.length>0&&(""!==o.text().trim()||o.find("img, video, a").length>0)&&(i=!0),t.remove(),i})(t.html)),o||(t.html='<div class="so-widget-preview-empty">'+m("No widget preview available.","so-widgets-bundle")+"</div>"),i({widgetPreviewHtml:t.html,previewInitialized:!1}),e.setAttributes({widgetMarkup:t.html,widgetIcons:t.widgetIcons})}).fail(e=>{i({widgetFormHtml:"<div>"+k(e)+"</div>"})}).always(()=>{n&&wp.data.dispatch("core/editor").unlockPostSaving(),i({loadingWidgetPreview:!1})})},S=({props:e,widget:t})=>l(()=>n(j,{...e,widget:t}),[e,t]);class j extends d{constructor(e){super(e),this.initialState={editing:void 0===e.attributes.widgetData,formInitialized:!1,loadingForm:!1,loadingWidgetPreview:!1,previewInitialized:!1,widgetFormHtml:"",widgetPreviewHtml:"",widgetSettingsChanged:!1,previewDebounceTimer:null},this.state={...this.initialState,isStillMounted:!0,devModeRemount:!1},e.attributes.widgetClass||this.props.setAttributes({widgetClass:e.widget.class})}componentDidMount(){this.setState({...this.initialState,isStillMounted:!0}),this.loadWidgetData()}componentWillUnmount(){this.setState({...this.initialState,isStillMounted:!1,devModeRemount:!0})}componentDidUpdate(e,t){this.state.isStillMounted&&(this.state.editing===t.editing&&this.props.attributes.widgetData===e.attributes.widgetData||(this.setState({widgetSettingsChanged:!0,widgetPreviewHtml:null,previewInitialized:!1}),this.loadWidgetData()))}loadWidgetData(){if(!this.state.isStillMounted)return;const{editing:e,widgetFormHtml:t,loadingForm:i,loadingWidgetPreview:o}=this.state,{attributes:s}=this.props;if(e||!s.widgetData){return void(!t.length&&!i&&(this.setState({loadingForm:!0}),jQuery.post({url:sowbBlockEditorAdmin.restUrl+"sowb/v1/widgets/forms",beforeSend:e=>{e.setRequestHeader("X-WP-Nonce",sowbBlockEditorAdmin.nonce)},data:{widgetClass:this.props.widget.class,widgetData:s.widgetData}}).done(e=>{this.setState({widgetFormHtml:e}),setTimeout(()=>{this.setState({loadingForm:!1,formInitialized:!1})},0)}).fail(e=>{this.setState({widgetFormHtml:"<div>"+k(e)+"</div>"})})))}!o&&!e&&(this.props.setAttributes({widgetMarkup:null,widgetIcons:null}),y(this.props,this.state.loadingWidgetPreview,this.setState.bind(this),!1,this.props.widget.class))}render(){const{editing:e,widgetFormHtml:t,loadingForm:i,widgetPreviewHtml:o,loadingWidgetPreview:s,previewInitialized:r}=this.state,{attributes:d}=this.props;return n("div",null,e||!d.widgetData?[!!t&&n(a,{key:"controls"},n(c,{label:m("Widget Preview Controls","so-widgets-bundle")},n(g,{label:m("Preview widget.","so-widgets-bundle"),onClick:()=>this.setState({editing:!1}),icon:"visibility"}))),n(w,{key:"placeholder",className:"so-widget-block-form siteorigin-widget-form wp-core-ui",label:this.props.widget.name,instructions:this.props.widget.description},i?n("div",{className:"so-widgets-spinner-container"},n("span",null,n(b))):n("div",{className:"so-widget-block-container siteorigin-widget-form wp-core-ui",dangerouslySetInnerHTML:{__html:t},ref:()=>{(async(e,t,i)=>{const o=sowbGetBlockForm(e.clientId);sowbMaybeSetupSiteEditorAssets(),o.length>0&&!t.formInitialized&&(o.siblings(".siteorigin-widget-preview").find("> a").on("click",function(e){e.stopImmediatePropagation(),i({editing:!1,previewInitialized:!1,widgetPreviewHtml:!1})}),o.data("backupDisabled",!0),e.attributes.widgetData?sowbForms.setWidgetFormValues(o,e.attributes.widgetData):e.setAttributes({widgetData:sowbForms.getWidgetFormValues(o)}),o.sowSetupForm(),o.on("change",function(){if(o.data("sow-form-setup")){var s=sowbForms.getWidgetFormValues(o);e.setAttributes({widgetData:s}),clearTimeout(t.previewDebounceTimer),t.previewDebounceTimer=setTimeout(()=>{y(e,t.loadingWidgetPreview,i,s,e.widget.class)},300)}}),i({formInitialized:!0}))})(this.props,this.state,this.setState.bind(this),this.props.widget.class).then(()=>{sowbBlockEditorAdmin.wpScriptDebug&&!this.state.devModeRemount||(()=>{if(0!==sowbSiteEditorCanvas.length)try{const e=sowbSiteEditorCanvas[0].contentWindow;e&&e.postMessage({action:"sowbBlockFormInit"},"*")}catch(e){console.error("SiteOrigin Widgets: Failed to send postMessage to iframe:",e)}})()})}}))]:[n(a,{key:"controls"},n(c,{label:m("Widget Edit Controls","so-widgets-bundle")},n(g,{label:m("Edit widget.","so-widgets-bundle"),onClick:()=>this.setState({editing:!0,loadingForm:!1,widgetFormHtml:"",formInitialized:!1}),icon:"edit"}))),n("div",{key:"preview",className:"so-widget-preview-container"},s?n("div",{className:"so-widgets-spinner-container"},n("span",null,n(b))):n("div",{dangerouslySetInnerHTML:{__html:o},ref:()=>{r||(jQuery(window.sowb).trigger("setup_widgets",{preview:!0}),this.setState({previewInitialized:!0}))}}))])}}r("sowb/widget-block",{title:m("SiteOrigin Widgets Block","so-widgets-bundle"),description:m("This block is intended as a legacy placeholder.","so-widgets-bundle"),attributes:{widgetClass:{type:"string"},anchor:{type:"string"},widgetData:{type:"object"},widgetMarkup:{type:"string"},widgetIcons:{type:"array"},widgetNotFound:{type:"boolean"}},supports:{inserter:!1},icon:function(){return n("span",{className:"widget-icon so-widget-icon so-block-editor-icon so-widget-icon-default"})},edit:function(e){const[t,o]=i.useState(!1),[s,r]=i.useState(!0);return i.useEffect(()=>{E().then(e=>{o(e),r(!1)})},[]),e.attributes.widgetNotFound?n(w,{label:m("SiteOrigin Widget","so-widgets-bundle"),className:"so-widget-block-form"},n("p",null,p(m("The widget for %s cannot be found.","so-widgets-bundle"),e.attributes.widgetClass))):s?n("div",{className:"so-widget-block-form so-widgets-spinner-container"},n("span",null,n(b))):n("div",{className:"so-widget-block-form"},n(w,{label:m("Legacy SiteOrigin Widget","so-widgets-bundle")},n("p",{dangerouslySetInnerHTML:{__html:sowbBlockEditorAdmin.legacyNotice}}),t?n(u,{isPrimary:!0,onClick:()=>{r(!0),setTimeout(()=>{sowbBlockEditorAdmin.consent=!0,sowbBlockEditorAdmin.consentGiven=!0,sowbMigrateOldBlocks()},0),jQuery.post(ajaxurl,{action:"so_widgets_block_migration_notice_consent",nonce:sowbBlockEditorAdmin.migrationNotice})}},m("Migrate to New Block Format","so-widgets-bundle")):n("span",null,m("Please contact your site administrator to migrate this block.","so-widgets-bundle"))))},save:function(){return null}});let B=null;const E=()=>(null!==B||(B=new Promise((e,t)=>{jQuery.post({url:sowbBlockEditorAdmin.restUrl+"sowb/v1/widgets/permission",beforeSend:e=>{e.setRequestHeader("X-WP-Nonce",sowbBlockEditorAdmin.nonce)}}).done(t=>{e(t)}).fail(t=>{console.error("Failed to check admin permissions:",t),e(!1)})})),B),I={},M=[...Object.values(sowbBlockEditorAdmin.widgets)];await Promise.all(Object.entries(M).map(async([e,t])=>{(async(e,t)=>{if(e.blockName)return void 0!==e.manuallyRegister&&e.manuallyRegister?(I[e.blockName]=e,void delete M[t]):void 0;delete M[t]})(t,e)})),await soRegisterWidgetBlocks(I),Object.entries(I).forEach(([e,t])=>{t.blockName&&wp.hooks.addFilter("blocks.registerBlockType","sowb/"+t.blockName,function(e,i){return i!=="sowb/"+t.blockName?e:{...e,icon:v(t),keywords:t.keywords?t.keywords:"",category:"siteorigin",supports:{html:!1,anchor:!0},edit:e=>n(S,{props:e,widget:t})}})});M.forEach(e=>{e.blockName&&r("sowb/"+e.blockName,{title:e.name,description:e.description,icon:v(e),category:"siteorigin",keywords:e.keywords?e.keywords:"",supports:{html:!1,anchor:!0},attributes:{widgetClass:{type:"string"},anchor:{type:"string"},widgetData:{type:"object"},widgetMarkup:{type:"string"},widgetIcons:{type:"array"}},edit:t=>n(S,{props:t,widget:e}),save:function(e){return null}})}),h("siteorigin",{icon:n("img",{src:sowbBlockEditorAdmin.categoryIcon,alt:m("SiteOrigin Widgets Bundle Blocks Category","so-widgets-bundle"),style:{height:"20px",width:"20px"}})}),window.frameElement&&(sowbSiteEditorCanvas=window.frameElement,sowbMaybeSetupSiteEditorAssets())}(window.wp.blocks,window.wp.i18n,window.wp.element,window.wp.components,window.wp.blockEditor);let sowbSiteEditorCanvas=!1;const sowbGetBlockForm=e=>(!1===sowbSiteEditorCanvas&&(sowbSiteEditorCanvas=jQuery(".edit-site-visual-editor__editor-canvas")),0===sowbSiteEditorCanvas.length?jQuery('[data-block="'+e+'"]').find(".siteorigin-widget-form-main"):sowbSiteEditorCanvas.contents().find('[data-block="'+e+'"]').find(".siteorigin-widget-form-main")),sowbCanvasCloneElements=["#jquery-core-js","#jquery-migrate-js","#editor-js-after","#wp-tinymce-js","#wp-block-library-js-before","#jquery-ui-core-js","#jquery-ui-mouse-js","#jquery-ui-slider-js","#jquery-ui-sortable-js","#jquery-ui-resizable-js","#jquery-ui-draggable-js","#wplink-js-extra","#wplink-js","#buttons-css","#dashicons-css",'link[href*="wp-admin/load-styles.php"]',"#tmpl-attachment-details","#tmpl-attachment-display-settings","#tmpl-attachment","#tmpl-embed-link-settings","#tmpl-image-editor","#tmpl-media-frame","#tmpl-media-modal","#tmpl-media-selection","#tmpl-uploader-editor","#tmpl-uploader-inline","#tmpl-uploader-status-error","#tmpl-uploader-status","#tmpl-uploader-window","#editor-buttons-css","#forms-css","#media-views-css","#select2-css","#siteorigin-widget-admin-css","#siteorigin-widget-admin-js-extra","#siteorigin-widget-admin-js","#so-widgets-bundle-tpl-image-search-dialog","#so-widgets-bundle-tpl-image-search-result-sponsored","#so-widgets-bundle-tpl-image-search-result","#sowb-pikaday-js","#sowb-pikaday-css","#wp-color-picker-alpha-js","#so-autocomplete-field-js","#so-code-field-js","#so-date-range-field-js","#so-date-range-field-css","#so-icon-field-js","#so-image-radio-field-js","#so-image-size-js","#so-media-field-js","#so-multi-measurement-field-js","#so-multiple-image-shape-field-js","#so-multiple-media-field-js","#so-order-field-js","#so-posts-selector-field-js","#so-presets-field-js","#so-select-field-js","#so-tabs-field-js","#so-tinymce-field-js","#so-toggle-field-js"],sowbCloneElementsToCanvas=e=>{for(const t of sowbCanvasCloneElements){const i=jQuery(t);if(0===i.length)continue;const o=i[0]&&i[0].outerHTML;o&&(0===e.find(t).length&&e.append(o))}};let sowbSiteEditorAssetsSetup=!1;const sowbMaybeSetupSiteEditorAssets=()=>{if(0===sowbSiteEditorCanvas.length||sowbSiteEditorAssetsSetup)return void(sowbSiteEditorAssetsSetup=!0);sowbSiteEditorAssetsSetup=!0;const e=void 0!==sowbSiteEditorCanvas[0]?sowbSiteEditorCanvas[0]:sowbSiteEditorCanvas,t=jQuery(e.contentDocument).find("body");sowbCloneElementsToCanvas(t),void 0===e.contentWindow.ajaxurl&&(e.contentWindow.ajaxurl=window.ajaxurl)},sowbFindLegacyBlocks=e=>e.reduce((e,t)=>{if("core/widget-area"===t.name){return wp.data.select("core/block-editor").getBlocks(t.clientId).forEach(t=>{"sowb/widget-block"===t.name&&e.push(t)}),e}return"sowb/widget-block"===t.name&&e.push(t),t.innerBlocks&&t.innerBlocks.length>0&&e.push(...sowbFindLegacyBlocks(t.innerBlocks)),e},[]),sowbIsWidgetActive=e=>sowbBlockEditorAdmin.widgets.find(t=>t.class===e);let sowbMigrateBlockSubscribe=!1,sowbMigrationInProgress=!1;const sowbMigrateOldBlocks=()=>{if(!0===sowbMigrationInProgress)return;const e=wp.data.select("core/block-editor").getBlocks();if(0===e.length)return;const t=sowbFindLegacyBlocks(e);if(0!==t.length){if(sowbBlockEditorAdmin.consent){sowbMigrationInProgress=!0;try{t.forEach(e=>{try{if(!sowbIsWidgetActive(e.attributes.widgetClass)){const t={...e.attributes};return t.widgetNotFound=!0,void wp.data.dispatch("core/block-editor").updateBlock(e.clientId,{attributes:t})}const t=wp.blocks.createBlock("sowb/"+e.attributes.widgetClass.toLowerCase().replace(/_/g,"-"),e.attributes);t&&wp.data.dispatch("core/block-editor").replaceBlock(e.clientId,t)}catch(e){console.error("SiteOrigin Widget Block migration failed:",e)}})}finally{setTimeout(()=>{sowbMigrationInProgress=!1},100)}return!sowbBlockEditorAdmin.consentGiven&&sowbRemoveLegacyWidgetBlock()}"function"==typeof sowbMigrateBlockSubscribe&&sowbMigrateBlockSubscribe()}},sowbRemoveLegacyWidgetBlock=()=>(setTimeout(()=>{"function"==typeof sowbMigrateBlockSubscribe&&sowbMigrateBlockSubscribe()},0),!1),sowbIsMissingBlockSowb=e=>"core/missing"===e.name&&e.isValid&&e.attributes&&e.attributes.originalName.startsWith("sowb/"),sowbFindInactiveBlock=e=>e.reduce((e,t)=>{if("core/widget-area"===t.name){return wp.data.select("core/block-editor").getBlocks(t.clientId).forEach(t=>{sowbIsMissingBlockSowb(t)&&e.push(t)}),e}return sowbIsMissingBlockSowb(t)&&e.push(t),t.innerBlocks&&t.innerBlocks.length>0&&e.push(...sowbFindInactiveBlock(t.innerBlocks)),e},[]);if(jQuery(function(e){if(!e("body.block-editor-page").length)return;sowbBlockEditorAdmin.consent&&(sowbMigrateBlockSubscribe=wp.data.subscribe(sowbMigrateOldBlocks));const t=wp.data.subscribe(()=>{const e=wp.data.select("core/block-editor").getBlocks();if(0===e.length)return;const i=sowbFindInactiveBlock(e);i.length&&(setTimeout(()=>{(e=>{e.forEach(e=>{const t=document.querySelector(`[data-block="${e.clientId}"] .block-editor-warning__message`);t&&(t.innerHTML=sprintf(wp.i18n.__('The "%s" block is currently not available. The plugin or theme that powers the block might be deactivated or not installed. You can leave it as is or remove it. %sRead our troubleshooting guide for more details%s.',"so-widgets-bundle"),`<strong>${e.attributes.originalName}</strong>`,'<a href="https://siteorigin.com/widgets-bundle/troubleshooting/" target="_blank" rel="noopener noreferrer">',"</a>"))})})(i)},0),t())})}),"undefined"!=typeof adminpage&&"widgets-php"!=adminpage&&"function"==typeof wp.data.select){let e=!1;wp.data.subscribe(function(){if(!e&&"object"==typeof wp.data.select("core/editor")&&wp.data.select("core/editor").isSavingPost()){e=!0;var t=setInterval(function(){if(!wp.data.select("core/editor").isSavingPost()&&!wp.data.select("core/editor").isAutosavingPost()&&wp.data.select("core/editor").didPostSaveRequestSucceed()){clearInterval(t);for(var i=!0,o=wp.data.select("core/block-editor").getBlocks(),s=0;s<o.length;s++)o[s].name.startsWith("sowb/")&&o[s].isValid&&($form=jQuery("#block-"+o[s].clientId).find(".so-widget-block-form"),sowbForms.validateFields($form,i)||(i=!1),$form.find(".siteorigin-widget-field-is-required input").on("change",function(){sowbForms.validateFields($form)}));e=!1}},250)}})}